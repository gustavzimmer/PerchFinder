rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function verifiedUser() {
      return signedIn() && request.auth.token.email_verified == true;
    }

    function isAdmin() {
      return verifiedUser() &&
        exists(/databases/$(database)/documents/Admins/$(request.auth.uid));
    }

    function usernameClaimRef(usernameKey) {
      return /databases/$(database)/documents/UsernameIndex/$(usernameKey);
    }

    function hasUsernameClaim(uid, usernameKey) {
      return usernameKey is string &&
        exists(usernameClaimRef(usernameKey)) &&
        get(usernameClaimRef(usernameKey)).data.uid == uid;
    }

    function socialProfileRef(uid) {
      return /databases/$(database)/documents/SocialProfiles/$(uid);
    }

    function hasSocialProfile(uid) {
      return exists(socialProfileRef(uid));
    }

    function socialDisplayName(uid) {
      return get(socialProfileRef(uid)).data.displayName;
    }

    function validDisplayName(name) {
      return name is string && name.size() >= 3 && name.size() <= 24;
    }

    function validSocialProfile(uid, data) {
      return data.uid == uid &&
        validDisplayName(data.displayName) &&
        data.displayNameLower is string &&
        data.displayNameLower.size() >= 3 &&
        data.displayNameLower.size() <= 24 &&
        hasUsernameClaim(uid, data.displayNameLower);
    }

    function optionalShortString(value, maxLen) {
      return value == null || (value is string && value.size() <= maxLen);
    }

    function optionalNumberInRange(value, min, max) {
      return value == null ||
        ((value is int || value is float) && value >= min && value <= max);
    }

    function optionalListWithMaxItems(value, maxItems) {
      return value == null || (value is list && value.size() <= maxItems);
    }

    function validLatLng(location) {
      return location is map &&
        location.lat is number &&
        location.lng is number &&
        location.lat >= -90 &&
        location.lat <= 90 &&
        location.lng >= -180 &&
        location.lng <= 180;
    }

    function validCommentText(text) {
      return text is string && text.size() > 0 && text.size() <= 280;
    }

    function catchRef(catchId) {
      return /databases/$(database)/documents/Fangster/$(catchId);
    }

    function catchExists(catchId) {
      return exists(catchRef(catchId));
    }

    function friendRequestRef(fromUid, toUid) {
      return /databases/$(database)/documents/FriendRequests/$(fromUid + "_" + toUid);
    }

    match /Admins/{uid} {
      allow read: if verifiedUser() && request.auth.uid == uid;
      allow write: if isAdmin();
    }

    match /UsernameIndex/{usernameKey} {
      allow read: if verifiedUser();
      allow create, update, delete: if false;
    }

    match /SocialProfiles/{uid} {
      allow read: if verifiedUser();

      allow create: if verifiedUser() &&
        request.auth.uid == uid &&
        validSocialProfile(uid, request.resource.data) &&
        request.resource.data.friends is list &&
        request.resource.data.friends.size() == 0;

      allow update: if verifiedUser() &&
        request.auth.uid == uid &&
        validSocialProfile(uid, request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.friends is list &&
        resource.data.friends is list &&
        request.resource.data.friends == resource.data.friends;

      allow delete: if false;
    }

    match /FriendRequests/{requestId} {
      allow read: if verifiedUser() &&
        (resource.data.fromUid == request.auth.uid || resource.data.toUid == request.auth.uid);

      // Friend requests are server-controlled via Cloud Functions to avoid spoofing
      // and client clock/race issues.
      allow create, update, delete: if false;
    }

    match /DailyCatchEvents/{eventId} {
      allow read: if verifiedUser();
      allow create, update, delete: if false;
    }

    match /Fangster/{catchId} {
      allow read: if true;

      allow create: if verifiedUser() &&
        request.resource.data.keys().hasOnly([
          "waterId",
          "weightG",
          "lengthCm",
          "notes",
          "photoUrl",
          "photoUrls",
          "lure",
          "method",
          "weatherCode",
          "weatherSummary",
          "temperatureC",
          "pressureHpa",
          "caughtAt",
          "createdAt",
          "userId",
          "userName"
        ]) &&
        request.resource.data.waterId is string &&
        request.resource.data.waterId.size() > 0 &&
        request.resource.data.waterId.size() <= 120 &&
        request.resource.data.caughtAt is string &&
        request.resource.data.caughtAt.size() >= 16 &&
        request.resource.data.caughtAt.size() <= 40 &&
        request.resource.data.userId == request.auth.uid &&
        hasSocialProfile(request.auth.uid) &&
        request.resource.data.userName is string &&
        validDisplayName(request.resource.data.userName) &&
        request.resource.data.userName == socialDisplayName(request.auth.uid) &&
        optionalNumberInRange(request.resource.data.weightG, 0, 30000) &&
        optionalNumberInRange(request.resource.data.lengthCm, 0, 200) &&
        optionalShortString(request.resource.data.notes, 1000) &&
        optionalShortString(request.resource.data.photoUrl, 2048) &&
        optionalListWithMaxItems(request.resource.data.photoUrls, 8) &&
        (request.resource.data.lure == null || request.resource.data.lure is map) &&
        optionalShortString(request.resource.data.method, 80) &&
        (request.resource.data.weatherCode == null || request.resource.data.weatherCode is int) &&
        optionalShortString(request.resource.data.weatherSummary, 180) &&
        optionalNumberInRange(request.resource.data.temperatureC, -50, 60) &&
        optionalNumberInRange(request.resource.data.pressureHpa, 850, 1150) &&
        request.resource.data.createdAt != null;

      allow delete: if verifiedUser() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      allow update: if verifiedUser() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId &&
        request.resource.data.waterId == resource.data.waterId &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.caughtAt == resource.data.caughtAt &&
        request.resource.data.photoUrl == resource.data.photoUrl &&
        request.resource.data.photoUrls == resource.data.photoUrls &&
        request.resource.data.lure == resource.data.lure &&
        request.resource.data.method == resource.data.method &&
        request.resource.data.weatherCode == resource.data.weatherCode &&
        request.resource.data.weatherSummary == resource.data.weatherSummary &&
        request.resource.data.temperatureC == resource.data.temperatureC &&
        request.resource.data.pressureHpa == resource.data.pressureHpa &&
        request.resource.data.userName == resource.data.userName &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "weightG",
          "lengthCm",
          "notes"
        ]) &&
        optionalNumberInRange(request.resource.data.weightG, 0, 30000) &&
        optionalNumberInRange(request.resource.data.lengthCm, 0, 200) &&
        (request.resource.data.weightG != null || request.resource.data.lengthCm != null) &&
        optionalShortString(request.resource.data.notes, 1000);

      match /Likes/{uid} {
        allow read: if true;

        allow create: if verifiedUser() &&
          catchExists(catchId) &&
          request.auth.uid == uid &&
          hasSocialProfile(request.auth.uid) &&
          request.resource.data.keys().hasOnly([
            "uid",
            "userName",
            "createdAtMs",
            "createdAt"
          ]) &&
          request.resource.data.uid == request.auth.uid &&
          request.resource.data.userName is string &&
          validDisplayName(request.resource.data.userName) &&
          request.resource.data.userName == socialDisplayName(request.auth.uid) &&
          request.resource.data.createdAtMs is int &&
          request.resource.data.createdAt != null;

        allow delete: if verifiedUser() &&
          (request.auth.uid == uid || isAdmin());

        allow update: if false;
      }

      match /Comments/{commentId} {
        allow read: if true;

        allow create: if verifiedUser() &&
          catchExists(catchId) &&
          hasSocialProfile(request.auth.uid) &&
          request.resource.data.keys().hasOnly([
            "uid",
            "userName",
            "text",
            "createdAtMs",
            "createdAt"
          ]) &&
          request.resource.data.uid == request.auth.uid &&
          request.resource.data.userName is string &&
          validDisplayName(request.resource.data.userName) &&
          request.resource.data.userName == socialDisplayName(request.auth.uid) &&
          validCommentText(request.resource.data.text) &&
          request.resource.data.createdAtMs is int &&
          request.resource.data.createdAt != null;

        allow delete: if verifiedUser() && (
          resource.data.uid == request.auth.uid ||
          isAdmin() ||
          (
            catchExists(catchId) &&
            get(catchRef(catchId)).data.userId == request.auth.uid
          )
        );

        allow update: if false;
      }
    }

    match /FiskeVatten/{waterId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /Lures/{lureId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /FiskeVattenRequests/{requestId} {
      allow read: if isAdmin();

      allow create: if verifiedUser() &&
        request.resource.data.keys().hasOnly([
          "name",
          "location",
          "requestedAt",
          "requestedBy",
          "requestedByEmail",
          "requestedByName"
        ]) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 120 &&
        validLatLng(request.resource.data.location) &&
        request.resource.data.requestedAt != null &&
        request.resource.data.requestedBy == request.auth.uid &&
        request.resource.data.requestedByEmail == request.auth.token.email &&
        optionalShortString(request.resource.data.requestedByName, 24);

      allow update, delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
